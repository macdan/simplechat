<html>
	<head>
		<link rel="stylesheet" type="text/css" href="css/icons.css">
		<link rel="stylesheet" type="text/css" href="vendor/bootstrap/css/bootstrap.css">
		<script type="text/javascript" src="vendor/jquery/jquery-1.8.3.js"></script>
		<script type="text/javascript" src="vendor/bootstrap/js/bootstrap.js"></script>
		<script type="text/javascript" src="js/md5.js"></script>
	</head>
	<body>
		<style type="text/css">
		.event.joined,
		.event.parted {
			text-align: center;
			font-style: italic;
			color: #999;
		}
		button {
			min-height: 30px;
			vertical-align: middle;
		}
		</style>
		<script type="text/javascript">
var socket;
var nick;

//simplechat_room:join(P,<<"daniel_kendell@macdan.net">>).
//simplechat_room:say(P,<<"Hello World?">>).

function handle( p ) {
	switch ( p.type ) {
		case 'welcome':
			$('#modal-connect').modal('hide');
			break;
			
		case 'joined':
			console.log(p);
			if ( p.source == "client" ) {
				var room = p.room.name;
				$('#modal-join').modal('hide');
				newTab( tabId( room ), room );
				switchTab( tabId( room ) );
				socket.send( JSON.stringify( {
					type: 'member_list',
					room: room
				} ) );
				break;
			}
			
			var html = $('<li class="event joined">' + p.client + ' joined</li>');
			$('#' + tabId( p.room ) + ' ul.stream').append( html );
			break;
			
		case 'parted':
			var html = $('<li class="event joined">' + p.client + ' parted</li>');
			$('#' + tabId( p.room ) + ' ul.stream').append( html );
			break;
			
		case 'message':
			var html = $('#template-room-message').children().clone();
			html.find('h4').html( p.client );
			html.find('img').attr( { src: 'http://www.gravatar.com/avatar/' + MD5( p.client ) + '?default=identicon' } );
			html.find('p').html( p.body );
			$('#' + tabId( p.room ) + ' ul.stream').append( html );
			break;
		
		case 'error':
			var modal = $('#modal-error');
			modal.find('h3').html(p.title);
			modal.find('pre').html(p.message);
			modal.modal('show');
			break;
			
		default:
			console.log( 'Unhandled Message!' );
			console.log( p );
			break;
	}	
}

function tabId( id ) {
	return id.toLowerCase().replace( /\s/g, "" );
}

function switchTab( tab ) {
	$('#rooms .nav-tabs a[href="#' + tab + '"]').click()
}

function newTab( id, label ) {
	var tab = '<li><a data-toggle="tab" href="#' 
		+ id 
		+ '" data-toggle="tab">' 
		+ label 
		+ '  <span class="badge">1</span></a></li>';
		
	var pane = $('#template-room-pane').children().clone(true);
	pane.attr( "id", id );
	
	$('#rooms .nav-tabs').append( tab );
	$('#rooms .tab-content').append( pane );
}

$( function() {

	// Tabs - Hide notification count
	$( '#rooms .nav-tabs' ).on( 'shown', function (e) {
		var
			activated_tab = e.target,
			previous_tabe = e.relatedTarget;
		
		$( activated_tab ).find('.badge').hide();
	} );

	// Template: Room Tab Pane
	var pane = $('#template-room-pane');
	pane.find( '.msg-input button' ).on( 'click', function( e ) {
		console.log( 'send was clicked');
		
		var activeTab = $('#rooms .tab-pane.active');
		var room = activeTab.attr('id');
		
		var input = activeTab.find('input[name=body]');
		var message = input.val();
		input.val( '' );
		
		socket.send( JSON.stringify( {
			type: 'say',
			room: room,
			message: message
		} ) );
	} );
	pane.find( '.msg-input input' ).keyup( function( e ) {
	    if ( e.keyCode == 13 ) {
			console.log( "enter was pressed! going to click..." );
			console.log(  pane.find( '.msg-input button' ) );
			pane.find( '.msg-input button.btn-send' ).click();
	    }
	} );

	// Modal: Connect
	$('#modal-connect-btn').on( 'click', function( e ) {
		
		nick = $('#modal-connect-nickname').val();
		var pass = $('#modal-connect-password').val();
		
		socket = new WebSocket('ws://localhost:8000/');
		
		socket.onopen = function()
		{
			console.log( 'WebSocket Opened' );
			
			socket.send( JSON.stringify( {
				type: "ident",
				name: nick,
				password: pass
			} ) );
		};
		
		socket.onmessage = function( wsMsg )
		{
			console.log( 'Recv: ' + wsMsg.data );
		
			var msg = JSON.parse( wsMsg.data );
			handle( msg );
		};
		
		socket.onerror = function( e )
		{
			console.log( 'Websocket error!' );
			console.log( e );
		};
		
		socket.onclose = function()
		{
			console.log( 'WebSocket Closed' );
		};
	} );
	
	// Modal: Join
	$( '#modal-join-btn' ).on( 'click', function( e ) {
		
		var room = $('#modal-join-room').val();
		$('#modal-join-room').val('');
		
		socket.send( JSON.stringify( {
			type: "join",
			room: room
		} ) );
	} );
	
	// Modal: Error
	$( '#modal-error-btn' ).on( 'click', function( e ) {
		$( '#modal-error' ).modal( 'hide' );
	} );
	
// ---------------------------------------------------------------------------------
	
	$('#modal-connect').modal('show');
	//newTab( "myroom", "My Room" );
	//switchTab( "myroom" );
	
} );
		</script>
		
		<div class="container" style="margin-top: 10px;">
			<div class="row">
				<div class="span12" id="rooms">
				
					<ul class="nav nav-tabs">
						<li class="pull-right">
							<div class="btn-group">
								<a href="#modal-join" role="button" class="btn" data-toggle="modal">&plus;</a>
							</div>
						</li>
						<li class="active"><a href="#home" data-toggle="tab"><i class="icon-home"></i> Home</a></li>
						<li><a href="#debug" data-toggle="tab"><i class="icon-wrench"></i> Debug</a></li>
					</ul>
		
					<div class="tab-content">
						<div class="tab-pane active" id="home">
							<div class="well"><p>Foshizzle</p></div>
						</div>
						<div class="tab-pane" id="debug">
							<div class="well">
								<a href="#modal-connect" role="button" class="btn" data-toggle="modal">Connect</a>
								<a href="#modal-join" role="button" class="btn" data-toggle="modal">Join Room</a>
							</div>
						</div>
					</div>
				
				</div>
				
			</div>
		</div>
		
		<!-- Template: Room Tab Pane -->
		<div id="template-room-pane" style="display:none;">
			<div class="tab-pane" id="">
				<div class="row">
					<div class="span12">
						<div class="input-append msg-input">
							<input class="span10" type="text" name="topic" style="min-height: 30px;"/>
							<button class="btn" style="min-height: 30px;"><i class="icon-lock"></i></button>
							<button class="btn"><i class="icon-edit"></i> Set Topic</button>
						</div>
					</div>
				</div>
				<hr/>
				<div class="row">
					<!--div class="span9"-->
					<div class="span12">
						<ul class="media-list stream"></ul>
						<hr/>
						<div class="container input-append msg-input">
							<input type="text" name="body" style="min-height: 30px; width: 90%;"/>
							<button class="btn btn-primary btn-send">Send</button>
						</div>
					</div>
					<!--div class="span3">
						<button class="btn btn-danger btn-block"><i class="icon-remove"></i> Leave</button>
						<hr/>
						<ul class="media-list user-list">
							<li class="media">
								<a class="pull-left" href="#"><img class="media-object" src="http://placehold.it/24x24"></a>
								<div class="media-body">
									<h4 class="media-heading"><a href="#">User 1</a></h4>
								</div>
							</li>
							<li class="media">
								<a class="pull-left" href="#"><img class="media-object" src="http://placehold.it/24x24"></a>
								<div class="media-body">
									<h4 class="media-heading"><a href="#">User 2</a></h4>
								</div>
							</li>
						</ul>
					</div-->
				</div>
				
			</div>
		</div>
		
		<!-- Template: Room Message -->
		<div id="template-room-message" style="display:none;">
			<li class="media">
				<hr/>
				<a class="pull-left" href="#"><img class="media-object" src="http://placehold.it/64x64"></a>
				<div class="media-body">
					<h4 class="media-heading">Author</h4>
					<p>Foobar</p>
				</div>
			</li>
		</div>
		
		<!-- Modal: Error -->
		<div id="modal-error" class="modal hide" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">x</button>
				<h3>Error</h3>
			</div>
			<div class="modal-body">
				<pre>Error message...</pre>
			</div>
			<div class="modal-footer">
				<button class="btn btn-primary" id="modal-error-btn">Well that sucks</button>
			</div>
		</div>
		
		<!-- Modal: Connect -->
		<div id="modal-connect" class="modal hide" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">x</button>
				<h3>Connect</h3>
			</div>
			<div class="modal-body">
				<form class="form-horizontal">
					<div class="control-group">
						<input class="input-block-level" type="text" id="modal-connect-nickname" placeholder="Nickname">
					</div>
					<div class="control-group">
						<input class="input-block-level" type="password" id="modal-connect-password" placeholder="Password">
					</div>
				</form>
			</div>
			<div class="modal-footer">
				<button class="btn btn-primary" id="modal-connect-btn">Connect</button>
			</div>
		</div>
		
		<!-- Modal: Nick -->
		<div id="modal-join" class="modal hide" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">x</button>
				<h3>Join Room</h3>
			</div>
			<div class="modal-body">
				<form class="form-horizontal">
					<div class="control-group">
						<input class="input-block-level" type="text" id="modal-join-room" placeholder="Room Name">
					</div>
				</form>
			</div>
			<div class="modal-footer">
				<button class="btn btn-primary" id="modal-join-btn">Join Room</button>
			</div>
		</div>
				
	</body>
</html>
